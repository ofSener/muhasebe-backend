<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <location path="." inheritInChildApplications="false">
    <system.webServer>
      <!-- Handler for ASP.NET Core -->
      <handlers>
        <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModuleV2" resourceType="Unspecified" />
      </handlers>

      <!-- ASP.NET Core Module Configuration -->
      <aspNetCore processPath="dotnet"
                  arguments=".\IhsanAI.Api.dll"
                  stdoutLogEnabled="true"
                  stdoutLogFile=".\logs\stdout"
                  hostingModel="inprocess"
                  requestTimeout="00:05:00"
                  startupTimeLimit="120">
        <environmentVariables>
          <environmentVariable name="ASPNETCORE_ENVIRONMENT" value="Production" />
          <environmentVariable name="DOTNET_PRINT_TELEMETRY_MESSAGE" value="false" />
        </environmentVariables>
      </aspNetCore>

      <!-- CORS Configuration for IIS -->
      <httpProtocol>
        <customHeaders>
          <add name="Access-Control-Allow-Origin" value="*" />
          <add name="Access-Control-Allow-Methods" value="GET, POST, PUT, DELETE, OPTIONS, PATCH" />
          <add name="Access-Control-Allow-Headers" value="Content-Type, Authorization, X-Requested-With, Accept, Origin" />
          <add name="Access-Control-Allow-Credentials" value="true" />
          <add name="Access-Control-Max-Age" value="86400" />
          <!-- Security Headers -->
          <add name="X-Content-Type-Options" value="nosniff" />
          <add name="X-Frame-Options" value="SAMEORIGIN" />
          <add name="X-XSS-Protection" value="1; mode=block" />
          <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
          <remove name="X-Powered-By" />
        </customHeaders>
      </httpProtocol>

      <!-- Security Settings -->
      <security>
        <requestFiltering removeServerHeader="true">
          <!-- Max request size: 100MB -->
          <requestLimits maxAllowedContentLength="104857600" maxUrl="4096" maxQueryString="2048" />
          <!-- Block dangerous file extensions -->
          <fileExtensions allowUnlisted="true">
            <add fileExtension=".config" allowed="false" />
            <add fileExtension=".cs" allowed="false" />
            <add fileExtension=".csproj" allowed="false" />
            <add fileExtension=".asax" allowed="false" />
          </fileExtensions>
          <!-- Block dangerous HTTP verbs -->
          <verbs allowUnlisted="true">
            <add verb="TRACE" allowed="false" />
            <add verb="TRACK" allowed="false" />
          </verbs>
          <!-- Hidden segments -->
          <hiddenSegments>
            <add segment="bin" />
            <add segment="App_Code" />
            <add segment="App_Data" />
          </hiddenSegments>
        </requestFiltering>
      </security>

      <!-- URL Rewrite Rules (requires IIS URL Rewrite Module) -->
      <rewrite>
        <rules>
          <!-- Handle OPTIONS preflight requests -->
          <rule name="CORS Preflight" stopProcessing="true">
            <match url=".*" />
            <conditions>
              <add input="{REQUEST_METHOD}" pattern="^OPTIONS$" />
            </conditions>
            <action type="CustomResponse" statusCode="204" statusReason="No Content" />
          </rule>

          <!-- Redirect HTTP to HTTPS (uncomment if needed)
          <rule name="HTTPS Redirect" stopProcessing="true">
            <match url="(.*)" />
            <conditions>
              <add input="{HTTPS}" pattern="^OFF$" />
            </conditions>
            <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
          </rule>
          -->
        </rules>
        <outboundRules>
          <!-- Remove Server header -->
          <rule name="Remove Server Header">
            <match serverVariable="RESPONSE_Server" pattern=".+" />
            <action type="Rewrite" value="" />
          </rule>
        </outboundRules>
      </rewrite>

      <!-- Static Content Compression -->
      <httpCompression>
        <dynamicTypes>
          <add mimeType="application/json" enabled="true" />
          <add mimeType="application/json; charset=utf-8" enabled="true" />
        </dynamicTypes>
        <staticTypes>
          <add mimeType="application/json" enabled="true" />
          <add mimeType="text/*" enabled="true" />
        </staticTypes>
      </httpCompression>
      <urlCompression doStaticCompression="true" doDynamicCompression="true" />

      <!-- Static Content Caching -->
      <staticContent>
        <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="7.00:00:00" />
        <mimeMap fileExtension=".json" mimeType="application/json" />
        <mimeMap fileExtension=".woff" mimeType="font/woff" />
        <mimeMap fileExtension=".woff2" mimeType="font/woff2" />
      </staticContent>

      <!-- Custom Error Pages -->
      <httpErrors errorMode="DetailedLocalOnly" existingResponse="PassThrough">
        <remove statusCode="404" />
        <remove statusCode="500" />
      </httpErrors>

      <!-- Default Document -->
      <defaultDocument enabled="false" />

      <!-- Directory Browsing - Disabled for security -->
      <directoryBrowse enabled="false" />
    </system.webServer>
  </location>

  <!-- Global settings outside of location -->
  <system.web>
    <httpRuntime maxRequestLength="102400" executionTimeout="300" />
  </system.web>
</configuration>
